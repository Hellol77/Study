# 7장 신뢰할 수 없는 코드를 쓰면서 불변성 지키기

레거시 코드 : 오래전에 만든 것, 지금 당장 고칠 수 없어서 그대로 사용해야 하는 코드

신뢰할 수 없는 코드와 데이터를 주고받는 문제를 푸는 방법은 복사본을 만드는 것입니다.

우리가 작성한 코드를 안전지대에 있다고 한다면 (카피-온-라이트)

안전지대 밖에 있는 레거시 코드는 무슨일이 일어나는지 정확히 알 수 없습니다. 그래서 데이터가 바뀌는 것을 완벽히 막아주는 원칙이 필요합니다.

이 원칙을 `방어적 복사`라고 합니다.

## 방어적 복사

### 들어오는 데이터 보호하기
1. 신뢰할 수 없는 코드에 있는 데이터
2. 데이터가 안전지대로 들어옵니다.
3. 깊은 복수를 합니다.

### 안전지대에서 나가는 데이터 보호하기
1. 안전지대에 있는 데이터
2. 깊은 복사를 합니다.
3. 깊은 복사를 한 데이터를 안전지대에서 내보냅니다.

### 방어적 복사 규칙

- 데이터가 안전한 코드에서 나갈 때 복사하기
    1. 불변성 데이터를 위하 깊은 복사본을 만듭니다.
    2. 신뢰할 수 없는 코드로 복사본을 전달합니다.

- 안전한 코드로 데이터가 들어올 때 복사하기
    1. 변경될 수도 있는 데이터가 들어오면 바로 깊은 복사본을 만들어 안전한 코드로 전달
    2. 복사본을 안전한 코드에서 사용합니다.

이 규칙들은 순서에 관계없이 쓸 수 있습니다.

### 익숙한 방어적 복사?

- 웹 API속에 방어적 복사

대부분의 웹 기반 api는 암묵적으로 방어적 복사를 합니다. (JSON 데이터가 api요청으로 들어올때)

- 얼랭과 엘릭서에서 방어적 복사



> 카피-온-라이트와 방어적 복사는 비슷한 것 같습니다.

방어적 복사는 깊은 복사를 합니다. 싶은 복사는 위에서 아래로 모든 계층의 중첩된 데이터를 복사하기 때문에 얕은 복사보다 더 많은 비용이 듭니다. 
안전지대에서는 데이터를 전달할 때 많은 복사를 하지 않아도 됩니다. 많은 복사본 때문에 연산과 메모리를 낭비하는 것을 막으려면 카피-온-라이트를 사용하는 것이 좋습니다.

### 카피-온-라이트
1. 언제 쓰나요?
    - 통제할 수 있는 데이터를 바꿀 때 카피-온-라이트
2. 어디서 쓰나요?
    - 안전지대 어디서나 쓸 수 있다. 카피-온-라이트가 불변성을 가진 안전지대를 만듭니다.
3. 복사 방식
    - 얕은 복사
4. 규칙
    - 바꿀 데이터의 얕은 복사를 만듭니다.
    - 복사본을 변경합니다.
    - 복사본을 리턴합니다.

### 방어적 복사
1. 언제 쓰나요?
    - 신뢰할 수 없는 코드와 데이터를 주고받아야 할때 방어적 복사를 씁니다.
2. 어디서 쓰나요?
    - 안전지대의 경계에서 데이터가 오고 갈 때 방어적 복사를 씁니다.
3. 복사 방식
    - 깊은 복사
4. 규칙
    - 안전지대로 들어오는 데이터에 깊은 복사를 만듭니다.
    - 안전지대에서 나가는 데이터에 깊은 복사를 만듭니다.

### 깊은 복사는 얕은 복사보다 비쌉니다.

https://velog.io/@y_jem/javascript-slice%EA%B0%80-1%EC%B0%A8%EC%9B%90-%EB%B0%B0%EC%97%B4%EC%9D%80-%EA%B9%8A%EC%9D%80-%EB%B3%B5%EC%82%AC-2%EC%B0%A8%EC%9B%90-%EB%B0%B0%EC%97%B4%EC%9D%80-%EC%96%95%EC%9D%80-%EB%B3%B5%EC%82%AC%EB%A5%BC-%EC%88%98%ED%96%89%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0

얕은 복사는 바뀌지 않는 값이라면 원본과 복사본이 데이터를 공유합니다.





